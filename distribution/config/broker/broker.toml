# Copyright 2023 The RocketMQ Rust Authors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.


# ======================
# Broker Identity
# ======================
[brokerIdentity]
brokerName = "broker-mxsm-a"          # default_broker_name()
brokerClusterName = "DefaultCluster-mxsm"
brokerId = 0                           # MASTER_ID
isBrokerContainer = false
isInBrokerContainer = false

# ======================
# Core Broker Settings
# ======================
regionId = "DefaultRegion"             # DEFAULT_TRACE_REGION_ID
brokerRole = "ASYNC_MASTER"             # enum BrokerRole: ASYNC_MASTER/AsyncMaster|SYNC_MASTER/SyncMaster|SLAVE/Slave
flushDiskType = "ASYNC_FLUSH"           # enum FlushDiskType: SYNC_FLUSH/SyncFlush|ASYNC_FLUSH/AsyncFlush
deleteWhen = 4

listenPort = 10911
brokerIp1 = "127.0.0.1"
brokerIp2 = "127.0.0.1"

traceTopicEnable = false
msgTraceTopicName = "RMQ_SYS_TRACE_TOPIC"
traceOn = true
brokerPermission = 6                   # READ(4)|WRITE(2)

asyncSendEnable = false
storePathRootDir = "/opt/data/rocketmq/store"

enableControllerMode = false
enableSplitRegistration = false
splitRegistrationSize = 800
registerBrokerTimeoutMills = 24000

# ======================
# Topic / Queue
# ======================
[topicQueueConfig]
defaultTopicQueueNums = 8

# ======================
# Timer Wheel
[timerWheelConfig]
timerWheelEnable = false

# ======================
# Features / Toggles
autoCreateTopicEnable = true
enableSingleTopicRegister = true
brokerTopicEnable = true
clusterTopicEnable = true
enableSlaveActingMaster = false
rejectTransactionMessage = false
enableDetailStat = true
duplicationEnable = false
recoverConcurrently = false

# POP / Retry
enableRetryTopicV2 = false
retrieveMessageFromPopRetryTopicV1 = true
popFromRetryProbability = 20
popResponseReturnActualRetryTopic = false
initPopOffsetByCheckMsgInMem = true
enablePopBufferMerge = false
enablePopBatchAck = false
enableSkipLongAwaitingAck = false
skipWhenCkRePutReachMaxTimes = false
enablePopLog = false
enablePopMessageThreshold = false

# Filtering / Property
enablePropertyFilter = false
filterSupportRetry = false
enableCalcFilterBitMap = false
maxErrorRateOfBloomFilter = 20
expectConsumerNumUseFilter = 32
bitMapLengthConsumeQueueExt = 64

# Mixed message types
enableMixedMessageType = false
autoDeleteUnusedStats = false
compressedRegister = false
transferMsgByHeap = true

# ======================
# Intervals / Timeouts (ms)
flushConsumerOffsetInterval = 5000
registerNameServerPeriod = 30000
shortPollingTimeMills = 1000
forwardTimeout = 3000
transactionTimeout = 6000
loadBalancePollNameServerInterval = 30000
reviveInterval = 1000
reviveScanTime = 10000
reviveAckWaitMs = 180000            # 3 * 60 * 1000
channelExpiredTimeout = 120000
subscriptionExpiredTimeout = 600000
popCkStayBufferTimeOut = 3000
popCkStayBufferTime = 10000
delayOffsetUpdateVersionStep = 200
transactionCheckInterval = 30000
transactionOpBatchInterval = 3000
syncBrokerMemberGroupPeriod = 1000
reviveMaxSlow = 3
brokerNotActiveTimeoutMillis = 10000
forwardTimeoutMs = 3000

# ======================
# POP / Buffer / Thresholds
popInflightMessageThreshold = 10000
popCkMaxBufferSize = 200000
popCkOffsetMaxQueueSize = 20000
popPollingMapSize = 100000
maxPopPollingSize = 100000
popPollingSize = 1024
defaultPopShareQueueNum = -1
popPollingSizeInternal = 1024

# ======================
# Message / Transaction
transactionOpMsgMaxSize = 4096
transactionCheckMax = 15
defaultMessageRequestMode = "Pull"    # enum MessageRequestMode: Pull/PULL|Pop/POP

# ======================
# Statistics / Ack / Resume
forceRegister = true
startAcceptSendRequestTimeStamp = 0
consumerOffsetUpdateVersionStep = 500
commercialSizePerMsg = 4096
commercialBaseCount = 1

# ======================
# POP Revive
reviveQueueNum = 8

# ======================
# Offsets / Reset
useServerSideResetOffset = true
slaveReadEnable = false

# ======================
# Nameserver
namesrvAddr = "127.0.0.1:9876"
fetchNameSrvAddrByDnsLookup = false
skipPreOnline = false

# ======================
# Reply / Forward / Escapes
storeReplyMessageEnable = true
enableRemoteEscape = false

# ======================
# Misc
lockInStrictMode = false

# ======================
# Derived / Advanced (leave unless tuning)
enableBroadcastOffsetStore = true
longPollingEnable = true

# ======================
# Example override section (uncomment to customize)
# brokerRole = "SyncMaster"
# autoCreateTopicEnable = false
# slaveReadEnable = true
# namesrvAddr = "10.0.0.10:9876;10.0.0.11:9876"

#===========Store config========================
# RocketMQ Message Store Configuration
[storeConfig]
# Storage paths
storePathRootDir = "~/store"
storePathCommitLog = ""
storePathDLedgerCommitLog = ""
storePathEpochFile = ""
storePathBrokerIdentity = ""
readOnlyCommitLogStorePaths = ""

# File sizes (in bytes)
mappedFileSizeCommitLog = 1073741824  # 1GB
compactionMappedFileSize = 104857600   # 100MB
compactionCqMappedFileSize = 10485760  # 10MB
mappedFileSizeTimerLog = 104857600     # 100MB
mappedFileSizeConsumeQueue = 6000000   # 300000 * 20
mappedFileSizeConsumeQueueExt = 50331648  # 48MB
mapperFileSizeBatchConsumeQueue = 13800000 # 300000 * 46

# Store type and features
storeType = "default"
enableCompaction = true
enableConsumeQueueExt = false
enableDLegerCommitLog = false
enableBatchPush = false
enableScheduleMessageStats = true
enableLmq = false
enableMultiDispatch = false
enableScheduleAsyncDeliver = false
enableAutoInSyncReplicas = false
enableCleanExpiredOffset = false
enableAsyncReput = true
enableBuildConsumeQueueConcurrently = false

# Timing and intervals
compactionScheduleInternal = 900000     # 15 minutes
timerPrecisionMs = 1000
timerRollWindowSlot = 172800           # 2 days
timerFlushIntervalMs = 1000
timerMaxDelaySec = 259200              # 3 days
disappearTimeAfterStart = -1
flushIntervalCommitLog = 500
commitIntervalCommitLog = 200
flushIntervalConsumeQueue = 1000
cleanResourceInterval = 10000
deleteCommitLogFilesInterval = 100
deleteConsumeQueueFilesInterval = 100
destroyMapedFileIntervalForcibly = 120000
redeleteHangedFileInterval = 120000
flushDelayOffsetInterval = 10000

# Thread configurations
compactionThreadNum = 6
timerGetMessageThreadNum = 3
timerPutMessageThreadNum = 3
dispatchCqThreads = 10
batchDispatchRequestThreadPoolNums = 16

# Timer configurations
timerEnableDisruptor = false
timerEnableCheckMetrics = true
timerInterceptDelayLevel = false
timerWheelEnable = true
timerStopEnqueue = false
timerCheckMetricsWhen = "05"
timerSkipUnknownError = false
timerWarmEnable = false
timerStopDequeue = false
timerEnableRetryUntilSuccess = false
timerCongestNumEachSlot = 2147483647   # Integer.MAX_VALUE
timerMetricSmallThreshold = 1000000
timerProgressLogIntervalMs = 10000
timerColdDataCheckIntervalMs = 60000

# Disk and memory settings
deleteWhen = "04"
diskMaxUsedSpaceRatio = 75
diskSpaceWarningLevelRatio = 90
diskSpaceCleanForciblyRatio = 85
fileReservedTime = 72
deleteFileBatchMax = 10
maxOffsetMapSize = 104857600           # 100MB
maxMessageSize = 4194304               # 4MB
maxFilterMessageSize = 16000
maxRecoveryCommitlogFiles = 30
maxAsyncPutMessageRequests = 5000
maxBatchDeleteFilesNum = 50

# Transfer and memory limits
putMsgIndexHightWater = 600000
maxTransferBytesOnMessageInMemory = 262144    # 256KB
maxTransferCountOnMessageInMemory = 32
maxTransferBytesOnMessageInDisk = 65536       # 64KB
maxTransferCountOnMessageInDisk = 8
accessMessageInMemoryMaxRatio = 40
accessMessageInMemoryHotRatio = 26

# Index settings
messageIndexEnable = true
messageIndexSafe = false
maxHashSlotNum = 5000000
maxIndexNum = 20000000                 # 5000000 * 4
maxMsgsNumBatch = 64
bitMapLengthConsumeQueueExt = 64

# HA (High Availability) settings
haListenPort = 10912
haSendHeartbeatInterval = 5000
haHousekeepingInterval = 20000
haTransferBatchSize = 32768            # 32KB
haMasterAddress = ""
haMaxGapNotInSync = 268435456          # 256MB
haFlowControlEnable = false
maxHaTransferByteInSecond = 104857600  # 100MB
haMaxTimeSlaveNotCatchup = 15000

# Broker role and flush settings
brokerRole = "ASYNC_MASTER"
flushDiskType = "ASYNC_FLUSH"
syncFlushTimeout = 5000
putMessageTimeout = 8000
slaveTimeout = 3000
messageDelayLevel = "1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h"

# Flush settings
flushCommitLogTimed = true
useReentrantLockWhenPutMessage = true
checkCRCOnRecover = true
forceVerifyPropCRC = false
flushCommitLogLeastPages = 4
commitCommitLogLeastPages = 4
flushLeastPagesWhenWarmMapedFile = 4096
flushConsumeQueueLeastPages = 2
flushCommitLogThoroughInterval = 10000
commitCommitLogThoroughInterval = 200
flushConsumeQueueThoroughInterval = 60000

# Advanced settings
cleanFileForciblyEnable = true
warmMapedFileEnable = false
offsetCheckInSlave = false
debugLockEnable = false
duplicationEnable = false
diskFallRecorded = true
osPageCacheBusyTimeOutMills = 1000
defaultQueryMaxNum = 32
wakeCommitWhenPutMessage = true
wakeFlushWhenPutMessage = false
dispatchFromSenderThread = false

# Pool settings
transientStorePoolEnable = false
transientStorePoolSize = 5
fastFailIfNoBufferInStorePool = false

# DLedger settings
dLegerGroup = ""
dLegerPeers = ""
dLegerSelfId = ""
preferredLeaderId = ""

# Replica settings
totalReplicas = 1
inSyncReplicas = 1
minInSyncReplicas = 1
allAckInSyncStateSet = false
replicasPerDiskPartition = 1
syncMasterFlushOffsetWhenStartup = false
syncFromLastFile = false
asyncLearner = false

# LMQ settings
maxLmqConsumeQueueNum = 20000
scheduleAsyncDeliverMaxPendingLimit = 2000
scheduleAsyncDeliverMaxResendNum2Blocked = 3

# Advanced configuration
dispatchCqCacheNum = 4096
recheckReputOffsetFromCq = false
maxTopicLength = 127                   # Byte.MAX_VALUE (deprecated)
autoMessageVersionOnTopicLen = true
enabledAppendPropCRC = false
travelCqFileNumWhenGetMessage = 1
correctLogicMinOffsetSleepInterval = 1
correctLogicMinOffsetForceInterval = 300000

# Swap settings
mappedFileSwapEnable = true
commitLogForceSwapMapInterval = 43200000      # 12 hours
commitLogSwapMapInterval = 3600000            # 1 hour
commitLogSwapMapReserveFileNum = 100
logicQueueForceSwapMapInterval = 43200000     # 12 hours
logicQueueSwapMapInterval = 3600000           # 1 hour
cleanSwapedMapInterval = 300000               # 5 minutes
logicQueueSwapMapReserveFileNum = 20

# Cache and search settings
searchBcqByCacheEnable = true
pullBatchMaxMessageCount = 160
maxChecksumRange = 1073741824          # 1GB
logicalDiskSpaceCleanForciblyThreshold = 0.8
maxSlaveResendLength = 268435456       # 256MB

# Consume queue scan settings
maxConsumeQueueScan = 20000
sampleCountThreshold = 5000
sampleSteps = 32

# Cold data settings
coldDataFlowControlEnable = false
coldDataScanEnable = false
dataReadAheadEnable = true

# RocksDB settings
cleanRocksDBDirtyCQIntervalMin = 60
statRocksDBCQIntervalSec = 10
memTableFlushIntervalMs = 3600000      # 1 hour
realTimePersistRocksDBConfig = true
enableRocksDBLog = false
rocksdbCQDoubleWriteEnable = false
bottomMostCompressionTypeForConsumeQueueStore = "zstd"
rocksdbCompressionType = "lz4"
rocksdbFlushWalFrequency = 1024
rocksdbWalFileRollingThreshold = 1073741824   # 1GB

# Lock settings
topicQueueLockNum = 32
spinLockCollisionRetreatOptimalDegree = 1000
useABSLock = false

# Read settings
readUnCommitted = false
putConsumeQueueDataByFileChannel = true

# Combine CQ settings
combineCQLoadingCQTypes = "default;defaultRocksDB"
combineCQPreferCQType = "default"
combineAssignOffsetCQType = "default"
combineCQEnableCheckSelf = false
combineCQMaxExtraSearchCommitLogFiles = 3

# Logging settings
enableLogConsumeQueueRepeatedlyBuildWhenRecover = false